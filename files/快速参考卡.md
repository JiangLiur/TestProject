# Smart3D等级库复制 - 快速参考卡 (修订版)

## 🎯 核心概念速查

### 等级库复制流程
```
C1L01 (源等级)
    ↓ 复制所有数据
C1L02 (新等级)
    ↓ 修改壁厚
某些管径：SCH40 → SCH80
    ↓ 智能替换材料（基于位置）
分析PCMCD表格式 → 按位置精确替换材料和尺寸标准
```

## 📊 关键表单和字段

### 1. PipingMaterialsSpec
- **作用**: 等级基本信息
- **关键字段**: Specname（等级名称）

### 2. PipingSpecRuleData
- **作用**: 规格规则数据
- **关键字段**: 
  - SPECNAME（等级名称）
  - PipeSizeString（管径，如DN50）
  - SHORTCODE（管件类型代码）★新增★

### 3. PipingSpecPart
- **作用**: 具体管件零件数据
- **关键字段**:
  - SPECNAME（等级名称）
  - PipeSizeString（管径）
  - Schedule_FormulaText（壁厚）
  - PipingComponentShortCode（管件类型）★关键★
  - MATERIALCODE（材料代码）

### 4. PipingCommodityFilter
- **作用**: 管件类型定义
- **关键字段**: SHORTCODE（如"Elbow"、"Tee"）

### 5. PCMCD表 ★核心表★
- **作用**: 管件材料和尺寸描述
- **关键字段**:
  - SHORTCODE（管件类型）
  - SHORTMATERIALDESCRIPTION（短描述）
  - LONGMATERIALDESCRIPTION（长描述）★分析重点★

## 🔑 四大关键改进

### 改进1: SHORTCODE精确匹配
```
❌ 错误: 只用管径+壁厚定位
✅ 正确: 管径+壁厚+SHORTCODE定位

示例：
DN50 + SCH40 + "Elbow" → 定位到弯头
DN50 + SCH40 + "Tee"   → 定位到三通
```

### 改进2: 基于位置的智能替换 ★重大升级★
```
❌ 错误: 简单字符串替换（可能误替换）
✅ 正确: 分析格式→确定位置→按位置替换

流程:
1. 分析PCMCD表前622行
2. 识别材料标准和尺寸标准的位置
3. 建立位置规则
4. 按位置精确替换

示例:
原文: "Elbow, 90°, ASTM A234 WPB, Butt Weld, SCH40, ASME B16.9"
       位置0   位置1  位置2(材料)    位置3      位置4(尺寸) 位置5

替换后: "Elbow, 90°, ASTM A420 WPL6, Butt Weld, SCH80, ASME B16.9"
                     ↑位置2替换           ↑位置4替换
```

### 改进3: 旧壁厚定位
```
❌ 错误: 用新壁厚查找Part表
✅ 正确: 用旧壁厚查找，再修改为新壁厚

步骤:
1. 查找 SCH40（旧壁厚）
2. 修改为 SCH80（新壁厚）
```

### 改进4: 中英文对应
```
❌ 问题: 等级表用中文，数据库用英文
✅ 解决: 建立对应表

弯头 → "Elbow"
三通 → "Tee"
管帽 → "Cap"
```

## 📝 配置文件模板

### config.json (更新版)
```json
{
  "source_grade": "C1L01",
  "target_grade": "C1L02",
  
  "schedule_mappings": [
    {
      "pipe_size": "DN50",
      "old_schedule": "SCH40",
      "new_schedule": "SCH80"
    }
  ],
  
  "material_replacements": {
    "ASTM A105": "ASTM A350 LF2",
    "ASTM A234 WPB": "ASTM A420 WPL6"
  },
  
  "size_standard_replacements": {
    "SCH40": "SCH80",
    "SCH STD": "SCH 80"
  },
  
  "pcmcd_analysis": {
    "analyze_rows": 622,
    "export_format_rules": true
  }
}
```

## 🔍 关键操作步骤

### 步骤1: 分析PCMCD表格式 ★新增★
```
1. 读取PCMCD表前622行
2. 分析LONGMATERIALDESCRIPTION格式
3. 识别材料标准位置（通常在位置2-3）
4. 识别尺寸标准位置（通常在位置4-5）
5. 生成格式规则JSON文件
```

**代码示例**:
```python
# 分析格式
format_stats = analyze_pcmcd_format(pcmcd_df, num_rows=622)
format_rules = extract_dominant_positions(format_stats)

# 保存规则
with open('format_rules.json', 'w') as f:
    json.dump(format_rules, f)
```

### 步骤2: 确认SHORTCODE对应关系
```
1. 打开PipingSpecRuleData.xlsx
2. 查看PipingCommodityFilter表
3. 记录中文名称对应的SHORTCODE
4. 填入对应表
```

### 步骤3: 准备输入数据
```
Excel模板1: C1L01等级-输入数据模板.xlsx
- 壁厚映射表（所有需要修改的管径）
- 材料替换表（所有需要替换的材料对）

Excel模板2: 中文名称-SHORTCODE对应表.xlsx
- 所有管件类型的中英文对应关系
```

### 步骤4: 运行程序
```python
# 伪代码
1. 读取配置和数据
2. 分析PCMCD表格式 → format_rules.json
3. 复制源等级 → 新等级
4. 对每个管径:
   - 获取SHORTCODE
   - 用旧壁厚+SHORTCODE定位Part表
   - 修改为新壁厚
5. 基于位置智能替换材料和尺寸标准
6. 验证和导出
```

## 📋 PCMCD格式分析示例

### 典型格式结构
```
管件类型    规格     材料标准           连接方式    尺寸标准    标准规范
   ↓         ↓          ↓                ↓          ↓          ↓
Elbow,     90°,   ASTM A234 WPB,   Butt Weld,   SCH40,   ASME B16.9
位置0      位置1      位置2            位置3       位置4      位置5

替换规则:
- 位置2: 材料标准替换
- 位置4: 尺寸标准替换
```

### 不同管件的格式差异
```
Elbow:   位置2=材料, 位置4=尺寸
Tee:     位置2=材料, 位置4=尺寸
Flange:  位置3=材料, 位置2=尺寸(压力等级)
```

## ⚠️ 常见错误

### 错误1: 简单字符串替换
```
问题: "ASTM A105, Flanged, ASTM标准"
简单替换: 会把"ASTM标准"也替换掉
位置替换: 只替换位置2或3的ASTM A105
```

### 错误2: 找不到Part记录
```
原因: 用新壁厚查找
解决: 改用旧壁厚查找
```

### 错误3: 修改了错误的管件
```
原因: 没有用SHORTCODE区分
解决: 添加SHORTCODE匹配条件
```

### 错误4: 格式规则不准确
```
原因: 分析样本太少
解决: 分析完整的622行数据
```

## 📊 验证检查清单

- [ ] PCMCD格式已分析（622行）
- [ ] format_rules.json已生成
- [ ] 所有配置的管径壁厚都已修改
- [ ] 材料标准已按位置替换
- [ ] 尺寸标准已按位置替换
- [ ] SHORTCODE匹配正确
- [ ] 修改记录数量与预期一致
- [ ] 旧材料标准搜索结果为0
- [ ] 在Smart3D中测试通过

## 🚀 快速开始命令

```bash
# 1. 准备环境
pip install pandas openpyxl

# 2. 分析PCMCD格式（重要！）
python analyze_pcmcd.py

# 3. 查看生成的格式规则
cat format_rules.json

# 4. 准备配置文件
# 编辑 config.json

# 5. 运行主程序
python smart3d_grade_copy.py

# 6. 验证结果
python verify_results.py
```

## 📞 需要帮助？

### 检查以下文档
1. Smart3D等级库复制程序-实现文档.md - 完整说明
2. PCMCD格式分析指南.md - 格式分析详解 ★新增★
3. 关键改进说明.md - 详细改进点

### 提供以下信息
1. 原始Excel文件（包含PCMCD表）
2. 配置文件
3. format_rules.json
4. 错误日志
5. 具体问题描述

## 🎯 关键成功因素

1. **准确的格式分析**: 必须正确分析PCMCD表的622行数据
2. **精确的位置规则**: 每种管件的材料和尺寸位置必须准确
3. **完整的验证**: 替换后必须全面验证
4. **充分的备份**: 操作前必须备份原始数据

---

**快速参考卡版本**: 2.0（基于位置的智能替换版）  
**最后更新**: 2025-11-13  
**重大改进**: 从简单字符串替换升级为位置智能替换
